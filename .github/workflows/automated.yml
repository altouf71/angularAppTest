name: PR Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # Frontend (Angular)
      # -----------------------------
      - name: Setup Node for frontend
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install frontend deps
        run: |
          cd frontend
          npm install

      - name: Angular Lint
        run: |
          cd frontend
          npm run lint
        continue-on-error: true

      - name: Angular Tests
        run: |
          cd frontend
          npm run test -- --watch=false --browsers=ChromeHeadless
        continue-on-error: true

      - name: Angular Build
        run: |
          cd frontend
          npm run build -- --configuration production

      # -----------------------------
      # Backend (Node.js)
      # -----------------------------
      - name: Install backend deps
        run: |
          cd backend
          npm install

      - name: Backend Tests
        run: |
          cd backend
          npm test -- --coverage
        continue-on-error: true

      - name: Security Scan
        run: |
          cd backend
          npm audit --production
        continue-on-error: true

      # -----------------------------
      # Get PR Diff
      # -----------------------------
      - name: Get PR Diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }} > changes.diff

      # -----------------------------
      # Generate Suggested Test Cases
      # -----------------------------
      - name: Generate Suggested Tests
        run: |
          echo "Generating scenarios..."
          python3 << 'EOF'
import re

# Read diff
with open("changes.diff", "r") as f:
    diff = f.read()

scenarios = []

# Basic patterns
if "component.ts" in diff:
    scenarios.append("- Test that Angular component renders correctly.")
if ".service.ts" in diff:
    scenarios.append("- Validate updated Angular service logic.")
if "express" in diff.lower() or "router" in diff.lower():
    scenarios.append("- API endpoint behavior updated â€” test route responses.")
if "form" in diff:
    scenarios.append("- Validate form validation rules and UI errors.")

# Fallback
if not scenarios:
    scenarios.append("No special changes detected â€” run general smoke tests.")

# Save output
with open("scenarios.txt", "w") as f:
    f.write("\n".join(scenarios))
EOF

      - name: Upload scenarios artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-scenarios
          path: scenarios.txt

      # -----------------------------
      # Comment on PR
      # -----------------------------
      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "### ğŸ¤– Automated Quality Report"
          recreate: true
          message: |
            **CI Completed**

            - Angular lint/test/build done
            - Backend test + audit done

            ### Suggested Manual Test Scenarios
            \`\`\`
            (See attached scenarios.txt artifact)
            \`\`\`
