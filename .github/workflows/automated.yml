name: PR Quality Gate (Demo)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # -------------------------------------
      # ANGULAR FRONTEND
      # -------------------------------------
      - name: Setup Node (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Angular Dependencies
        run: |
          cd frontend
          npm install

      - name: Angular Lint
        run: |
          cd frontend
          npm run lint
        continue-on-error: true

      - name: Angular Tests
        run: |
          cd frontend
          npm run test -- --watch=false --browsers=ChromeHeadless
        continue-on-error: true

      - name: Angular Build
        run: |
          cd frontend
          npm run build -- --configuration production

      # -------------------------------------
      # NODE.JS BACKEND
      # -------------------------------------
      - name: Install Backend Dependencies
        run: |
          cd backend
          npm install

      - name: Run Backend Tests (Jest)
        run: |
          cd backend
          npm test -- --coverage
        continue-on-error: true

      - name: Security Scan (npm audit)
        run: |
          cd backend
          npm audit --production
        continue-on-error: true

      # -------------------------------------
      # ANALYZE DIFF FOR TEST SCENARIOS
      # -------------------------------------
      - name: Get PR Diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }} > changes.diff

      - name: Generate Suggested Tests
        id: suggestions
        run: |
          echo "Running test scenario generator..."
          python3 << 'EOF'
import re

with open("changes.diff", "r") as f:
    diff = f.read()

scenarios = []

# Basic examples
if "component.ts" in diff:
    scenarios.append("- Test UI component renders without errors")
if ".service.ts" in diff:
    scenarios.append("- Test service methods return expected results")
if "routes" in diff or "express" in diff.lower():
    scenarios.append("- Test API endpoints return correct responses")
if "form" in diff:
    scenarios.append("- Validate Angular form validation rules")

if not scenarios:
    scenarios.append("No specific changes detected â€” run general smoke tests.")

with open("scenarios.txt", "w") as f:
    f.write("\n".join(scenarios))
EOF

      - name: Upload Scenarios Artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-scenarios
          path: scenarios.txt

      # -------------------------------------
      # COMMENT BACK INTO PR
      # -------------------------------------
      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          header: "### ðŸ” PR Automated Quality Check (Demo)"
          message: |
            **Frontend (Angular):**
            - Lint: Completed
            - Tests: Completed
            - Build: Completed

            **Backend (Node.js):**
            - Tests: Completed
            - Security Scan: Completed

            ### ðŸ”¬ Suggested Manual Test Scenarios:
            ```
            ${{ steps.suggestions.outputs }}
            ```
